<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Génération Ticket PDF</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #ffffff; /* fond blanc */
      color: #333333; /* texte gris foncé pour bonne lisibilité */
      margin: 20px;
    }
    h1 {
      color: #4a3f8e; /* violet foncé */
      text-align: center;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #4a3f8e;
    }
    input[type="text"],
    select {
      width: 300px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 5px;
    }
    input[type="file"] {
      margin-top: 5px;
    }
    button {
      margin-top: 20px;
      background-color: #6b46c1; /* violet */
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #553c9a; /* violet plus foncé */
    }
    #preview-container {
      margin-top: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background-color: #f9f9f9; /* léger gris clair pour contraste */
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    #preview-container.hidden {
      display: none;
    }
    #preview-container img {
      max-width: 150px;
      max-height: 150px;
      display: block;
      margin-top: 15px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Génération de Ticket PDF</h1>

  <form id="form-ticket">
    <label for="nom">Nom :</label>
    <input type="text" id="nom" name="nom" required />

    <label for="quartier">Quartier :</label>
    <input type="text" id="quartier" name="quartier" />

    <label for="numero">Téléphone :</label>
    <input type="text" id="numero" name="numero" />

    <label for="presence">Présence :</label>
    <select id="presence" name="presence" required>
      <option value="Présent">Présent</option>
      <option value="Absent">Absent</option>
      <option value="Invité">Invité</option>
    </select>

    <label for="photo">Photo (JPEG/PNG) :</label>
    <input type="file" id="photo" name="photo" accept="image/jpeg, image/png" />

    <button type="submit">Générer le PDF</button>
  </form>

  <div id="preview-container" class="hidden">
    <h2>Aperçu :</h2>
    <div id="preview-text"></div>
    <img id="preview-photo" src="" alt="Photo sélectionnée" />
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const form = document.getElementById("form-ticket");
    const previewContainer = document.getElementById("preview-container");
    const previewText = document.getElementById("preview-text");
    const previewPhoto = document.getElementById("preview-photo");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const data = {
        nom: formData.get("nom"),
        quartier: formData.get("quartier"),
        numero: formData.get("numero"),
        presence: formData.get("presence"),
      };

      let photoDataUrl = null;

      const photoFile = formData.get("photo");
      if (photoFile && photoFile.size > 0) {
        photoDataUrl = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(photoFile);
        });
      }

      // Affichage preview texte
      previewText.innerHTML = `
        <p><strong>Nom :</strong> ${data.nom}</p>
        <p><strong>Quartier :</strong> ${data.quartier || "-"}</p>
        <p><strong>Téléphone :</strong> ${data.numero || "-"}</p>
        <p><strong>Présence :</strong> ${data.presence}</p>
      `;

      if (photoDataUrl) {
        previewPhoto.src = photoDataUrl;
        previewPhoto.classList.remove("hidden");
      } else {
        previewPhoto.src = "";
        previewPhoto.classList.add("hidden");
      }

      previewContainer.classList.remove("hidden");

      // Génération PDF quand on clique
      generatePdf(data, photoDataUrl);
    });

    function generatePdf(data, photoDataUrl) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: "portrait",
        unit: "pt",
        format: "a4",
      });

      // Marges
      const marginLeft = 40;
      const marginTop = 40;
      let y = marginTop;

      // Logo
      const logo = new Image();
      logo.src = "logo.jpg";
      logo.onload = () => {
        doc.addImage(logo, "JPEG", marginLeft, y, 100, 50);

        y += 60;

        // Texte en haut
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor("#4a3f8e"); // violet foncé
        doc.text("MINISTÈRE EYIN-HAQQORE (MEYINHA-HERMON)", marginLeft, y);
        y += 18;
        doc.setFontSize(12);
        doc.setTextColor("#6b46c1"); // violet plus clair
        doc.text("L'ÉGLISE LOCALE D’AKANDA - DÉPARTEMENT JEUNESSE", marginLeft, y);
        y += 30;

        // Titre
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.setTextColor("#4a3f8e");
        doc.text("Ticket - Grande Retraite des Jeunes", marginLeft, y);
        y += 30;

        // Infos texte
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        doc.setTextColor("#333333"); // texte sombre

        const leftX = marginLeft;
        const rightX = 320; // place image à droite

        const lineHeight = 18;

        // Texte colonne gauche
        const lines = [
          `Nom : ${data.nom}`,
          `Quartier : ${data.quartier || "-"}`,
          `Téléphone : ${data.numero || "-"}`,
          `Présence : ${data.presence}`,
          `Lieu : Route-stade, en face du CES d'Avorbam`,
          `Date : Dimanche 16h00 à Lundi 17h00`,
          `Programme : 24h dans Sa présence`
        ];

        lines.forEach((line, idx) => {
          doc.text(line, leftX, y + idx * lineHeight);
        });

        // Image à droite si présente
        if (photoDataUrl) {
          const img = new Image();
          img.src = photoDataUrl;
          img.onload = () => {
            doc.addImage(img, "JPEG", rightX, marginTop + 80, 150, 150);
            doc.save(`Ticket_${data.nom.replace(/\s/g, "_")}.pdf`);
          };
          img.onerror = () => {
            doc.save(`Ticket_${data.nom.replace(/\s/g, "_")}.pdf`);
          };
        } else {
          doc.save(`Ticket_${data.nom.replace(/\s/g, "_")}.pdf`);
        }
      };
      logo.onerror = () => {
        // Si logo non chargé, on continue sans
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor("#4a3f8e");
        doc.text("MINISTÈRE EYIN-HAQQORE (MEYINHA-HERMON)", marginLeft, y);
        y += 18;
        doc.setFontSize(12);
        doc.setTextColor("#6b46c1");
        doc.text("L'ÉGLISE LOCALE D’AKANDA - DÉPARTEMENT JEUNESSE", marginLeft, y);
        y += 30;

        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.setTextColor("#4a3f8e");
        doc.text("Ticket - Grande Retraite des Jeunes", marginLeft, y);
        y += 30;

        const leftX = marginLeft;
        const rightX = 320;

        const lineHeight = 18;

        const lines = [
          `Nom : ${data.nom}`,
          `Quartier : ${data.quartier || "-"}`,
          `Téléphone : ${data.numero || "-"}`,
          `Présence : ${data.presence}`,
          `Lieu : Route-stade, en face du CES d'Avorbam`,
          `Date : Dimanche 16h00 à Lundi 17h00`,
          `Programme : 24h dans Sa présence`
        ];

        lines.forEach((line, idx) => {
          doc.text(line, leftX, y + idx * lineHeight);
        });

        if(photoDataUrl){
          const img = new Image();
          img.src = photoDataUrl;
          img.onload = () => {
            doc.addImage(img, "JPEG", rightX, marginTop + 80, 150, 150);
            doc.save(`Ticket_${data.nom.replace(/\s/g, "_")}.pdf`);
          };
          img.onerror = () => {
            doc.save(`Ticket_${data.nom.replace(/\s/g, "_")}.pdf`);
          };
        } else {
          doc.save(`Ticket_${data.nom.replace(/\s/g, "_")}.pdf`);
        }
      };
    }
  </script>
</body>
</html>
